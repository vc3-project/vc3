---
- name: Allow docker container to authenticate with condor
  blockinfile:
    path: "/etc/condor/condor_config.local"
    block: |
      DOCKER = 172.17.0.0/24
      ALLOW_WRITE  = $(ALLOW_WRITE), $(DOCKER)
      ALLOW_READ   = $(ALLOW_READ), $(DOCKER)

- name: Get HTCondor IP Address
  command: condor_status -schedd -af MyAddress
  register: htcondor_ipaddr

- name: Update condor address in reana configuration
  replace:
    path: /usr/local/reana/reana-cluster-vc3.yaml
    regexp: '^(\s*)- HTCONDOR_ADDR: .*'
    replace: "\1- HTCONDOR_ADDR: '{{ htcondor_ipaddr.stdout }}'"
  ignore_errors: yes

- name: start reana-cluster
  shell: |
    source /etc/profile.d/kubernetes.sh
    source /usr/local/reana/bin/activate
    reana-cluster -f /usr/local/reana/reana-cluster-vc3.yaml init

- name: Setup reana-cluster environment
  shell: |
    source /etc/profile.d/kubernetes.sh
    source /usr/local/reana/bin/activate
    wait_reana(){
      local max_retries=20
      count=0
      until [ $count -ge $max_retries ]
      do
          if reana-cluster status > /dev/null 2>&1; then
              break
          fi
          ((count++))
          sleep 15
      done
      if [ $count -ge $max_retries ]; then
          echo "Reana did not succeed"
          return 1
      else
          sleep 2
          reana-cluster env --include-admin-token > /etc/profile.d/reana.sh
          return 0
      fi
    }
    wait_reana

- name: Source REANA virtual environment by default
  lineinfile:
    path: "~{{ item.key }}/.bashrc"
    state: present
    insertafter: EOF
    line: 'source /usr/local/reana/bin/activate'
  with_dict: "{{ production_keys }}"
